#! /usr/bin/env python
# encoding: utf-8

cfg_deps = {
    'gconf': {
        'uselib': 'GCONF',
        'packages': 'gconf-2.0'
    }
}

def build_cfg_backend(bld, name):
    cfg = bld.new_task_gen('cc', 'shlib')
    cfg.source = 'config-impl-%s.vala' % name
    deps = 'GMODULE GOBJECT'
    pkgs = 'gmodule-2.0'
    if name in cfg_deps:
        deps += ' ' + cfg_deps[name]['uselib']
        pkgs += ' ' + cfg_deps[name]['packages']
    cfg.uselib = deps
    cfg.packages = pkgs
    cfg.uselib_local = 'desktop-agnostic'
    cfg.target = 'da-cfg-' + name
    cfg.vapi_dirs = '.'
    cfg.includes='..'
    cfg.destvar = 'LIBDIR'
    cfg.subdir = 'desktop-agnostic/modules'

def set_options(opt):
    opt.add_option('--config-backends', type='string', help='Determines which configuration backend(s) will be built.', dest='config_backends', default='')

def build(bld):
    lib = bld.new_task_gen('cc', 'shlib')
    lib.source = 'color.vala config-iface.vala config-bridge.vala config-schema.vala module.vala'
    lib.packages = 'gdk-2.0 gmodule-2.0'
    lib.target = 'desktop-agnostic'
    lib.uselib = 'GDK GMODULE'
    lib.vapi_dirs = './vapi'
    lib.includes='..'
    bld.install_files('DATADIR', 'vala/vapi', 'desktop-agnostic.vapi')

    t_cfg_bridge = bld.new_task_gen('cc', 'program')
    t_cfg_bridge.source = 'test-config-bridge.vala'
    t_cfg_bridge.uselib = 'GMODULE GOBJECT'
    t_cfg_bridge.uselib_local = 'desktop-agnostic'
    t_cfg_bridge.vapi_dirs = '.'
    t_cfg_bridge.includes = '..'
    t_cfg_bridge.target = 'test-config-bridge'

    [build_cfg_backend(bld, cfg) for cfg in bld.env['BACKENDS_CFG']]
