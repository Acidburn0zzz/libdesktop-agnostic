#! /usr/bin/env python
# encoding: utf-8

cfg_deps = {
    'gconf': {
        'uselib': 'GCONF',
        'packages': 'gconf-2.0'
    }
}

cfg_type_deps = {
}

def build_cfg_backend(bld, name):
    cfg = bld.new_task_gen('cc', 'shlib')
    cfg.source = 'config-impl-%s.vala' % name
    deps = 'GMODULE GOBJECT'
    pkgs = 'gmodule-2.0'
    if name in cfg_deps:
        deps += ' ' + cfg_deps[name]['uselib']
        pkgs += ' ' + cfg_deps[name]['packages']
    cfg.uselib = deps
    cfg.packages = pkgs
    cfg.uselib_local = 'desktop-agnostic'
    cfg.target = 'da-cfg-' + name
    cfg.vapi_dirs = '.'
    cfg.includes='..'
    cfg.install_path = None
    bld.install_files('${LIBDIR}/desktop-agnostic/modules',
                      bld.env['shlib_PATTERN'] % cfg.target)

def build_cfg_type(bld, name):
    cfg = bld.new_task_gen('cc', 'shlib')
    cfg.source = 'config-type-%s.vala' % name
    deps = 'GMODULE GOBJECT'
    pkgs = 'gmodule-2.0'
    if name in cfg_type_deps:
        deps += ' ' + cfg_type_deps[name]['uselib']
        pkgs += ' ' + cfg_type_deps[name]['packages']
    cfg.uselib = deps
    cfg.packages = pkgs
    cfg.uselib_local = 'desktop-agnostic'
    cfg.target = 'da-cfg-type-' + name
    cfg.vapi_dirs = '.'
    cfg.includes='..'
    cfg.install_path = None
    bld.install_files('${LIBDIR}/desktop-agnostic/modules',
                      bld.env['shlib_PATTERN'] % cfg.target)

def set_options(opt):
    opt.add_option('--config-backends', type='string',
                   help='Determines which configuration backend(s) will be built.',
                   dest='config_backends', default='')

def build(bld):
    lib = bld.new_task_gen('cc', 'shlib')
    lib.source = ' '.join([
        'color.vala',
        'config-iface.vala',
        'config-bridge.vala',
        'config-schema.vala',
        'config-schema-option.vala',
        'config-schema-type.vala',
        'module.vala',
        'vfs-glob.vala'
        ])
    lib.packages = 'gdk-2.0 gmodule-2.0'
    lib.target = 'desktop-agnostic'
    lib.uselib = 'GDK GMODULE'
    lib.packages_private = 'posix-glob posix-errno'
    lib.vapi_dirs = '.'
    lib.includes='..'

    [build_cfg_type(bld, name) for name in ['color']]

    t_cfg_bridge = bld.new_task_gen('cc', 'program')
    t_cfg_bridge.source = 'test-config-bridge.vala'
    t_cfg_bridge.uselib = 'GMODULE GOBJECT'
    t_cfg_bridge.uselib_local = 'desktop-agnostic'
    t_cfg_bridge.vapi_dirs = '.'
    t_cfg_bridge.includes = '..'
    t_cfg_bridge.target = 'test-config-bridge'
    t_cfg_bridge.install_path = ''

    t_color = bld.new_task_gen('cc', 'program')
    t_color.source = 'test-color.vala'
    t_color.uselib = 'GMODULE GDK'
    t_color.uselib_local = 'desktop-agnostic'
    t_color.vapi_dirs = '.'
    t_color.includes = '..'
    t_color.target = 'test-color'
    t_color.install_path = ''

    t_glob = bld.new_task_gen('cc', 'program')
    t_glob.source = 'test-vfs-glob.vala'
    t_glob.uselib_local = 'desktop-agnostic'
    t_glob.vapi_dirs = '.'
    t_glob.includes = '..'
    t_glob.target = 'test-vfs-glob'
    t_glob.install_path = ''

    [build_cfg_backend(bld, cfg) for cfg in bld.env['BACKENDS_CFG']]
